-- Group: contactmerge
-- Name: merged
-- Notes:  Lists all merged contacts
-- Copyright (c) 1999-2019 by OpenMFG LLC, d/b/a xTuple.
-- See www.xtuple.com/EULA for the full text of the software license.

SELECT cntct_id,
  CASE
    WHEN (cntctUsed(cntctmrgd_cntct_id)=false) THEN
      3 -- Already merged contact
    ELSE
      4 -- Already merged contact, but still has relationships
  END AS status,
  cntct.*,
  getcontactphone(cntct_id, 'Office') AS contact_phone,
  getcontactphone(cntct_id, 'Mobile') AS contact_phone2,
  getcontactphone(cntct_id, 'Fax') AS contact_fax,
  crmacct_number,crmacct_name,
  addr_id, addr_line1, addr_line2, addr_line3, addr_city, addr_state,
  addr_postalcode, addr_country, addr_active, addr_notes, addr_number,
  0 AS xtindentrole,
  CASE
    WHEN (cntctUsed(cntctmrgd_cntct_id)=false) THEN
      'warning' -- Already merged contact
    ELSE
      'error'  -- Already merged contact, but still has relationships
  END AS qtforegroundrole
FROM cntct
  JOIN cntctmrgd ON (cntct_id=cntctmrgd_cntct_id)
  LEFT OUTER JOIN addr ON (cntct_addr_id=addr_id)
  LEFT OUTER JOIN crmacctcntctass ON (crmacctcntctass_cntct_id=cntct_id)
  LEFT OUTER JOIN crmacct ON (crmacctcntctass_crmacct_id=crmacct_id);
