-- Group: customers
-- Name:  detail
-- Notes: 
--        Copyright (c) 1999-2019 by OpenMFG LLC, d/b/a xTuple.
--        See www.xtuple.com/EULA for the full text of the software license.

 WITH chartext AS (SELECT charass_target_id, charass_char_id,
                          string_agg(charass_value, ',') AS charass_value
                     FROM custinfo
                     JOIN charass ON charass_target_type = 'C'
                                 AND cust_id = charass_target_id
                    WHERE charass_char_id IN (-1
                                              <? foreach("char_id_text_list") ?>
                                                ,<? value("char_id_text_list") ?>
                                              <? endforeach ?>
                                             )
                    GROUP BY charass_target_id, charass_char_id),
      charlist AS (SELECT charass_target_id, charass_char_id,
                          string_agg(charass_value, ',') AS charass_value
                     FROM custinfo
                     JOIN charass ON charass_target_type = 'C'
                                 AND cust_id = charass_target_id
                    WHERE charass_char_id IN (-1
                                              <? foreach("char_id_list_list") ?>
                                                ,<? value("char_id_list_list") ?>
                                              <? endforeach ?>
                                             )
                    GROUP BY charass_target_id, charass_char_id),
      chardate AS (SELECT charass_target_id, charass_char_id,
                          MIN(charass_value::DATE) AS charass_value
                     FROM custinfo
                     JOIN charass ON charass_target_type = 'C'
                                 AND cust_id = charass_target_id
                    WHERE charass_char_id IN (-1
                                              <? foreach("char_id_date_list") ?>
                                                ,<? value("char_id_date_list") ?>
                                              <? endforeach ?>
                                             )
                    GROUP BY charass_target_id, charass_char_id),
_customers AS (
SELECT cust_id, cust_custtype_id,
  cust_active, cust_number, cust_name,
  custtype_code,
  formatBoolYN(cust_active) as f_active,
  formatAddr(bill_addr.addr_id) AS f_bill_addr,
  formatAddr(corr_addr.addr_id) AS f_corr_addr,
  CASE cust_creditstatus WHEN 'W' THEN <? value('creditwarn')?>
			WHEN 'H' THEN <? value('credithold')?>
			WHEN 'G' THEN ''  -- Good Status
			ELSE cust_creditstatus
			END as holdtype,
  bill_cntct.cntct_name AS bill_cntct_name,
  bill_cntct.cntct_first_name AS bill_first_name,
  bill_cntct.cntct_last_name AS bill_last_name,
  bill_cntct.cntct_title AS bill_title,
  getcontactphone(bill_cntct.cntct_id, 'Office') AS bill_phone,
  getcontactphone(bill_cntct.cntct_id, 'Fax') AS bill_fax,
  bill_cntct.cntct_email AS bill_email,
  bill_addr.addr_line1 AS bill_line1,
  bill_addr.addr_line2 AS bill_line2,
  bill_addr.addr_line3 AS bill_line3,
  bill_addr.addr_city AS bill_city,
  bill_addr.addr_state AS bill_state,
  bill_addr.addr_postalcode AS bill_postalcode,
  bill_addr.addr_country AS bill_country,
  corr_cntct.cntct_name AS corr_cntct_name,
  corr_cntct.cntct_first_name AS corr_first_name,
  corr_cntct.cntct_last_name AS corr_last_name,
  corr_cntct.cntct_title AS corr_title,
  getcontactphone(corr_cntct.cntct_id, 'Office') AS corr_phone,
  getcontactphone(corr_cntct.cntct_id, 'Fax') AS corr_fax,
  corr_cntct.cntct_email AS corr_email,
  corr_addr.addr_line1 AS corr_line1,
  corr_addr.addr_line2 AS corr_line2,
  corr_addr.addr_line3 AS corr_line3,
  corr_addr.addr_city AS corr_city,
  corr_addr.addr_state AS corr_state,
  corr_addr.addr_postalcode AS corr_postalcode,
  corr_addr.addr_country AS corr_country
<? foreach("char_id_text_list") ?>
  , charass_alias<? literal("char_id_text_list") ?>.charass_value AS char<? literal("char_id_text_list") ?>
<? endforeach ?>
<? foreach("char_id_list_list") ?>
  , charass_alias<? literal("char_id_list_list") ?>.charass_value AS char<? literal("char_id_list_list") ?>
<? endforeach ?>
<? foreach("char_id_date_list") ?>
  , charass_alias<? literal("char_id_date_list") ?>.charass_value::date AS char<? literal("char_id_date_list") ?>
<? endforeach ?>

  FROM custinfo
  JOIN custtype ON (cust_custtype_id=custtype_id)
  LEFT OUTER JOIN cntct bill_cntct ON (cust_cntct_id=bill_cntct.cntct_id)
  LEFT OUTER JOIN addr bill_addr ON (bill_cntct.cntct_addr_id=bill_addr.addr_id)
  LEFT OUTER JOIN cntct corr_cntct ON (cust_corrcntct_id=corr_cntct.cntct_id)
  LEFT OUTER JOIN addr corr_addr ON (corr_cntct.cntct_addr_id=corr_addr.addr_id)
<? foreach("char_id_text_list") ?>
  LEFT OUTER JOIN chartext charass_alias<? literal("char_id_text_list") ?> ON ((charass_alias<? literal("char_id_text_list") ?>.charass_target_id=cust_id)
                                                                    AND  (charass_alias<? literal("char_id_text_list") ?>.charass_char_id=<? value("char_id_text_list") ?>))
  LEFT OUTER JOIN char char_alias<? literal("char_id_text_list") ?> ON (charass_alias<? literal("char_id_text_list") ?>.charass_char_id=char_alias<? literal("char_id_text_list") ?>.char_id)
<? endforeach ?>
<? foreach("char_id_list_list") ?>
  LEFT OUTER JOIN charlist charass_alias<? literal("char_id_list_list") ?> ON ((charass_alias<? literal("char_id_list_list") ?>.charass_target_id=cust_id)
                                                                    AND  (charass_alias<? literal("char_id_list_list") ?>.charass_char_id=<? value("char_id_list_list") ?>))
  LEFT OUTER JOIN char char_alias<? literal("char_id_list_list") ?> ON (charass_alias<? literal("char_id_list_list") ?>.charass_char_id=char_alias<? literal("char_id_list_list") ?>.char_id)
<? endforeach ?>
<? foreach("char_id_date_list") ?>
  LEFT OUTER JOIN chardate charass_alias<? literal("char_id_date_list") ?> ON ((charass_alias<? literal("char_id_date_list") ?>.charass_target_id=cust_id)
                                                                    AND  (charass_alias<? literal("char_id_date_list") ?>.charass_char_id=<? value("char_id_date_list") ?>))
  LEFT OUTER JOIN char char_alias<? literal("char_id_date_list") ?> ON (charass_alias<? literal("char_id_date_list") ?>.charass_char_id=char_alias<? literal("char_id_date_list") ?>.char_id)
<? endforeach ?>
WHERE true
<? if not exists("showInactive") ?>
  AND cust_active
<? endif ?>
<? if exists("cust_number_pattern") ?>
  AND (cust_number ~* <? value("cust_number_pattern") ?>)
<? endif ?>
<? if exists("cust_name_pattern") ?>
  AND (cust_name ~* <? value("cust_name_pattern") ?>)
<? endif ?>
<? if exists("cust_custtype_id") ?>
  AND (cust_custtype_id = <? value("cust_custtype_id") ?>)
<? endif ?>
<? if exists("custtype_code_pattern") ?>
  AND (custtype_code ~* <? value("custtype_code_pattern") ?>)
<? endif ?>
<? if exists("custgrp") ?>
  AND cust_id IN (SELECT groupsitem_reference_id FROM custgrpitem WHERE groupsitem_groups_id = <? value("custgrp") ?>)
<? endif ?>
<? if exists("cntct_name_pattern") ?>
  AND (COALESCE(bill_cntct.cntct_first_name,'') || ' ' || COALESCE(bill_cntct.cntct_last_name, '') ~* <? value("cntct_name_pattern") ?>
   OR  COALESCE(corr_cntct.cntct_first_name,'') || ' ' || COALESCE(corr_cntct.cntct_last_name, '') ~* <? value("cntct_name_pattern") ?>)
<? endif ?>
<? if exists("cntct_phone_pattern") ?>
  AND (phonejson(bill_cntct.cntct_id)::TEXT ~* <? value("cntct_phone_pattern") ?>
   OR  phonejson(corr_cntct.cntct_id)::TEXT ~* <? value("cntct_phone_pattern") ?>)
<? endif ?>
<? if exists("cntct_email_pattern") ?>
  AND (COALESCE(bill_cntct.cntct_email,'') ~* <? value("cntct_email_pattern") ?>
   OR  COALESCE(corr_cntct.cntct_email,'') ~* <? value("cntct_email_pattern") ?>)
<? endif ?>
<? if exists("addr_street_pattern") ?>
  AND (COALESCE(bill_addr.addr_line1,'') || ' ' || COALESCE(bill_addr.addr_line2,'') || ' ' || COALESCE(bill_addr.addr_line3,'') ~* <? value("addr_street_pattern") ?>
   OR  COALESCE(corr_addr.addr_line1,'') || ' ' || COALESCE(corr_addr.addr_line2,'') || ' ' || COALESCE(corr_addr.addr_line3,'') ~* <? value("addr_street_pattern") ?>)
<? endif ?>
<? if exists("addr_city_pattern") ?>
  AND (COALESCE(bill_addr.addr_city,'') ~* <? value("addr_city_pattern") ?>
   OR  COALESCE(corr_addr.addr_city,'') ~* <? value("addr_city_pattern") ?>)
<? endif ?>
<? if exists("addr_state_pattern") ?>
  AND (COALESCE(bill_addr.addr_state,'') ~* <? value("addr_state_pattern") ?>
   OR  COALESCE(corr_addr.addr_state,'') ~* <? value("addr_state_pattern") ?>)
<? endif ?>
<? if exists("addr_postalcode_pattern") ?>
  AND (COALESCE(bill_addr.addr_postalcode,'') ~* <? value("addr_postalcode_pattern") ?>
   OR  COALESCE(corr_addr.addr_postalcode,'') ~* <? value("addr_postalcode_pattern") ?>)
<? endif ?>
<? if exists("addr_country_pattern") ?>
  AND (COALESCE(bill_addr.addr_country,'') ~* <? value("addr_country_pattern") ?>
   OR  COALESCE(corr_addr.addr_country,'') ~* <? value("addr_country_pattern") ?>)
<? endif ?>
<? if exists("salesrep_id") ?>
  AND (cust_salesrep_id = <? value("salesrep_id") ?>)
<? endif ?>
<? if exists("holdtype") ?>
 AND CASE WHEN <? value("holdtype") ?> = 1 THEN cust_creditstatus = 'W'
	  WHEN <? value("holdtype") ?> = 2 THEN cust_creditstatus = 'H'
	  ELSE cust_creditstatus = 'G' END
<? endif ?>
<? literal("charClause") ?>
)
SELECT * FROM _customers
<? if exists("search_pattern") ?>
  WHERE FALSE
  <? foreach("search_fields") ?>
    OR <? literal("search_fields") ?>::TEXT ~* <? value("search_pattern") ?>
  <? endforeach ?>
<? endif ?>
ORDER BY cust_number;

